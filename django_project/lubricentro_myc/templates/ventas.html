{% load static %}
{% csrf_token %}

{% include "encabezado.html" %}

{% block content %}
    <body>
        <div id="ventas">
        
            <h1>Ventas</h1>
            
            <table class="operaciones">
              <tr>
                <td>Buscar Producto por Código</td>
                <td><input type="text" id="codigo" class='allownumericwithoutdecimal' style="margin: 0px 5px;"></td>
                <td><button class="btn btn-default" onClick="buscar_producto()">Añadir</button></td>
              </tr>
              <tr>
                <td></td>
                <td><button type="button" class="btn btn-primary vue-btn" data-toggle="modal" data-target="#buscador-productos-modal">Abrir buscador de productos</button><td>
                <td></td>
              </tr>
            </table>

            <table class="carrito-table">
                <thead>
                    <td style="width: 10%;">Código</td>
                    <td style="width: 60%;">Detalle</td>
                    <td style="width: 10%;">Precio Contado</td>
                    <td style="width: 5%;">Cantidad</td>
                    <td style="width: 15%;">Total</td>
                </thead>
                <tbody>
                </tbody>
            </table>

            <table class="resumen-venta">
              <tr>
                <td>
                  <input type="radio" checked name="pago" value="E" style="margin-right: 10px" onClick="check($(this))">Efectivo<br>
                  <input type="radio" name="pago" value="CC" style="margin-right: 10px" onClick="check($(this))">Cta.Cte.<br>
                </td>
                <td><span>Total<input readonly type="text" value="0"></span></td>
              </tr>
              <tr>
                <td>
                  <button type="button" disabled class="btn btn-primary vue-btn" style="margin-right: 10px" data-toggle="modal" data-target="#buscador-clientes-modal">Buscar Cliente</button>
                  <input hidden type="text">
                  <input readonly disabled type="text" style="width: 200px">
                </td>
                <td>
                  <button class="btn btn-default" style="float: right" onClick="guardar_venta()">Venta</button>
                  <button hidden class="btn btn-default" style="float: right" onClick="generar_remito()">Remito</button>
                </td>
              </tr>
            </table>
  
        </div>

    </body>

    <script type="text/javascript">

      function reload_js(){
        var head= document.getElementsByTagName('head')[0];
        var script= document.createElement('script');
        script.src= "{% static 'js/arithmetic_operations.js' %}";
        head.appendChild(script);
      }
      
      reload_js();

      function check(opcion) {
        if(opcion.val() == "E") {
          $('.resumen-venta tr:nth-child(2) td:nth-child(1) button')[0].disabled = true
          $('.resumen-venta tr:nth-child(2) td:nth-child(1) input')[1].disabled = true
          $('.resumen-venta tr:nth-child(2) td:nth-child(1) input')[0].value = ""
          $('.resumen-venta tr:nth-child(2) td:nth-child(1) input')[1].value = ""
          $('.resumen-venta tr:nth-child(2) td:nth-child(2) button')[0].hidden = false
          $('.resumen-venta tr:nth-child(2) td:nth-child(2) button')[1].hidden = true
        } else if(opcion.val() == "CC") {
          $('.resumen-venta tr:nth-child(2) td:nth-child(1) button')[0].disabled = false
          $('.resumen-venta tr:nth-child(2) td:nth-child(2) button')[0].hidden = true
        }
      }

      function remover_producto(codigo_producto) {
        var codigos = $('.carrito-table tbody tr td:nth-child(1) input');
        var detalles = $('.carrito-table tbody tr td:nth-child(2) input');
        var precios_contado = $('.carrito-table tbody tr td:nth-child(3) input');
        var cantidades = $('.carrito-table tbody tr td:nth-child(4) input');
        var totales = $('.carrito-table tbody tr td:nth-child(5) input');

        var carrito = $('.carrito-table tbody')[0];
        carrito.innerHTML = `<tbody></tbody>`;
        var total = 0;

        for(var i = 0; i < codigos.length; i++) {
          if(codigos[i].value != codigo_producto) {
            // toda esta logica deberia moverse a un metodo para ser reutilizada
            var tr = document.createElement('tr');

            var td = document.createElement("td");
            var input = document.createElement('input');
            input.type = "text";
            input.setAttribute("readonly", true);
            input.setAttribute("value", codigos[i].value);
            td.appendChild(input);
            tr.appendChild(td);

            var td = document.createElement("td");
            var input = document.createElement('input');
            input.type = "text";
            input.setAttribute("readonly", true);
            input.setAttribute("value", detalles[i].value);
            td.appendChild(input);
            tr.appendChild(td);

            var td = document.createElement("td");
            var input = document.createElement('input');
            input.type = "text";
            input.setAttribute("value", precios_contado[i].value);
            input.setAttribute("class", "allownumericwithdecimal");
            td.appendChild(input);
            tr.appendChild(td);
            
            var td = document.createElement("td");
            var input = document.createElement('input');
            input.type = "text";
            input.setAttribute("value", cantidades[i].value);
            input.setAttribute("class", "allownumericwithdecimal");
            input.setAttribute("onClick", "this.setSelectionRange(0, this.value.length)");
            td.appendChild(input);
            tr.appendChild(td);

            var td = document.createElement("td");
            var input = document.createElement('input');
            input.type = "text";
            input.setAttribute("readonly", true);
            input.setAttribute("value", totales[i].value);
            input.setAttribute("class", "allownumericwithdecimal");
            td.appendChild(input);
            tr.appendChild(td);

            var td = document.createElement("td");
            var input = document.createElement("input");
            input.type = "button";
            input.setAttribute("value", "Eliminar");
            input.setAttribute("class", "btn-default");
            input.setAttribute("onClick", "remover_producto(" + codigos[i].value + ")");
            td.appendChild(input);
            tr.appendChild(td);

            tr.appendChild(td);
            carrito.appendChild(tr);

            total += parseFloat(totales[i].value);
          } 
        }

        $('.resumen-venta tr:nth-child(1) td:nth-child(2) input').val(total.toFixed(2));
      }

      function buscar_producto() {
          var codigo = document.getElementById('codigo').value
          if (codigo.replace(/\s/g, "") == "") {
            return
          }
          axios({
            method:'get',
            url: `/lubricentro_myc/productos/` + codigo,
          }).then(response => {
            reload_js();
            
            if ($('.carrito-table tr:has(td input[value="' + response.data['codigo'] +'"])').length == 0) {
              var carrito = $('.carrito-table tbody')[0];
              var tr = document.createElement('tr');

              var td = document.createElement("td");
              var input = document.createElement('input');
              input.type = "text";
              input.setAttribute("readonly", true);
              input.setAttribute("value", response.data['codigo']);
              td.appendChild(input);
              tr.appendChild(td);

              var td = document.createElement("td");
              var input = document.createElement('input');
              input.type = "text";
              input.setAttribute("readonly", true);
              input.setAttribute("value", response.data['detalle'].toUpperCase());
              td.appendChild(input);
              tr.appendChild(td);

              var td = document.createElement("td");
              var input = document.createElement('input');
              input.type = "text";
              input.setAttribute("value", response.data['precio_venta_contado'].toFixed(2));
              input.setAttribute("class", "allownumericwithdecimal");
              td.appendChild(input);
              tr.appendChild(td);
              
              var td = document.createElement("td");
              var input = document.createElement('input');
              input.type = "text";
              input.setAttribute("value", "0");
              input.setAttribute("class", "allownumericwithdecimal");
              input.setAttribute("onClick", "this.setSelectionRange(0, this.value.length)");
              td.appendChild(input);
              tr.appendChild(td);

              var td = document.createElement("td");
              var input = document.createElement('input');
              input.type = "text";
              input.setAttribute("readonly", true);
              input.setAttribute("value", "0.0");
              input.setAttribute("class", "allownumericwithdecimal");
              td.appendChild(input);
              tr.appendChild(td);

              var td = document.createElement("td");
              var input = document.createElement("input");
              input.type = "button";
              input.setAttribute("value", "Eliminar");
              input.setAttribute("class", "btn-default");
              input.setAttribute("onClick", "remover_producto(" + response.data['codigo'] + ")");
              td.appendChild(input);
              tr.appendChild(td);

              tr.appendChild(td);
              carrito.appendChild(tr);

              $('.operaciones tr:nth-child(1) td input')[0].value = "";
            } else {
              alert("El producto ya esta cargado al carrito");
            }
          }).catch(function (error) {
            console.error(error);
          })
      }

      function generar_remito() {
        if(confirm("¿Almacenar y Visualizar Remito?")) {
          var productos = $('.carrito-table tbody tr td:nth-child(1) input')
          var cantidades = $('.carrito-table tbody tr td:nth-child(4) input')
          let opts = {
            headers: {
              "X-CSRFToken": jQuery("[name=csrfmiddlewaretoken]").val(),
            }
          }
          let data = {
            cliente : $('.resumen-venta tr:nth-child(2) td:nth-child(1) input')[0].value
          }
          axios.post("/lubricentro_myc/remito/", data, opts)
          .then((response)=> {
            var remito_pdf = "{{ host }}/lubricentro_myc/generar_remito_pdf?cod_remito=" + response.data['codigo']
            var lista_elementos = []
            for(var i = 0; i < productos.length; i++) {
              elemento_remito = {}
              elemento_remito['remito'] = response.data['codigo']
              elemento_remito['producto'] = productos[i].value
              elemento_remito['cantidad'] = cantidades[i].value
              lista_elementos.push(elemento_remito)
            }
            elementos = {}
            elementos['elementos'] = lista_elementos
            axios.post("/lubricentro_myc/elementos_remito/guardar_elementos/", elementos, opts)
            .then((response)=> {
              window.open(remito_pdf, '_blank');
              window.location.href = "{{ host }}/lubricentro_myc/ventas";
            }).catch((error) => {}
            )
          }).catch((error) => {}
          )
        }
      }

      function guardar_venta() {
        if(confirm("¿Realizar Venta?")) {
          var productos = $('.carrito-table tbody tr td:nth-child(1) input')
          var cantidades = $('.carrito-table tbody tr td:nth-child(4) input')
          var precios = $('.carrito-table tbody tr td:nth-child(5) input')
          let opts = {
            headers: {
              "X-CSRFToken": jQuery("[name=csrfmiddlewaretoken]").val(),
            }
          }
          var next_url = "{{ host }}/lubricentro_myc/ventas"
          var i;
          for(i = 0; i < productos.length; i++) {
              venta = {}
              venta['producto'] = productos[i].value
              venta['cantidad'] = cantidades[i].value
              venta['precio'] = precios[i].value
              axios.post("/lubricentro_myc/ventas_realizadas/", venta, opts)
              .then((response)=> {
              }).catch((error) => {}
              )
          }
          window.location.href = next_url
        }
      }

    </script>

{% endblock %}

{% include "vue_modal/buscador_productos_modal.html" %}
{% include "vue_modal/buscador_clientes_modal.html" %}

{% include "footer.html" %}